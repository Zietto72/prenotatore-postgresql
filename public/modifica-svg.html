<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modifica SVG</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">
  <div class="max-w-3xl mx-auto bg-white shadow rounded p-6 space-y-6">
    <h2 class="text-2xl font-bold text-blue-700">Modifica file SVG</h2>
    <p class="text-sm text-gray-600">Questa utility consente di aggiungere automaticamente gli attributi <code>class="posto"</code>, <code>data-posto</code> e <code>data-zona</code> a ogni rettangolo SVG, appiattire gruppi e pulire lo spazio codice.</p>

    <div>
      <label class="block mb-2 font-semibold">Seleziona file SVG</label>
      <input type="file" id="fileInput" accept=".svg" class="w-full border p-2 rounded" />
    </div>

    <button id="downloadBtn" disabled class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Scarica SVG modificato</button>

    <pre id="log" class="bg-gray-50 text-sm p-4 rounded border"></pre>
  </div>

  <script>
    let modifiedSVG = '';

    document.getElementById('fileInput').addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const parser = new DOMParser();
        const svgDoc = parser.parseFromString(e.target.result, "image/svg+xml");

        const gruppoPiantina = svgDoc.getElementById('PIANTINA');
        const rects = gruppoPiantina ? gruppoPiantina.querySelectorAll('rect[class]') : [];

        let sostituiti = 0;

        rects.forEach(rect => {
          let g = rect.parentElement;
          while (g && !g.hasAttribute('id')) {
            g = g.parentElement;
          }
          if (!g) return;

          const id = g.getAttribute('id');
          const zona = id ? id.split('_')[0] : '';
          const parent = rect.parentNode;
          const originalClass = rect.getAttribute("class").trim();

          const newRect = svgDoc.createElementNS("http://www.w3.org/2000/svg", "rect");
          newRect.setAttribute("class", `posto ${originalClass}`);
          newRect.setAttribute("data-posto", id);
          if (zona) newRect.setAttribute("data-zona", zona);

          Array.from(rect.attributes).forEach(attr => {
            if (attr.name !== 'class') {
              newRect.setAttribute(attr.name, attr.value);
            }
          });

          parent.replaceChild(newRect, rect);
          sostituiti++;
        });

        const flattenRepeatedGroups = () => {
          const allGroups = svgDoc.querySelectorAll('g[class]');
          allGroups.forEach(group => {
            while (
              group.childElementCount === 1 &&
              group.firstElementChild.tagName === 'g' &&
              group.firstElementChild.getAttribute('class') === group.getAttribute('class')
            ) {
              const inner = group.firstElementChild;
              while (inner.firstChild) {
                group.appendChild(inner.firstChild);
              }
              group.removeChild(inner);
            }
          });
        };

        flattenRepeatedGroups();

        const beautifySVG = (raw) => {
          return raw
            .replace(/>\s+</g, '><')
            .replace(/\n\s*\n/g, '\n')
            .replace(/[ \t]{2,}/g, '  ')
            .replace(/^\s+|\s+$/gm, '');
        };

        const serializer = new XMLSerializer();
        const rawSVG = serializer.serializeToString(svgDoc);
        modifiedSVG = beautifySVG(rawSVG);

        document.getElementById('downloadBtn').disabled = false;
        document.getElementById('log').textContent = `Modifica completata. Rettangoli aggiornati: ${sostituiti}`;
      };

      reader.readAsText(file);
    });

    document.getElementById('downloadBtn').addEventListener('click', function () {
      const blob = new Blob([modifiedSVG], { type: 'image/svg+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'svg_modificato.svg';
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
